diff a/Framework/Sources/History/SRGHistory.m b/Framework/Sources/History/SRGHistory.m	(rejected hunks)
@@ -299,18 +296,19 @@ - (NSString *)historyEntryWithUid:(NSString *)uid completionBlock:(void (^)(SRGH
 
 - (NSString *)saveHistoryEntryForUid:(NSString *)uid withLastPlaybackTime:(CMTime)lastPlaybackTime deviceUid:(NSString *)deviceUid completionBlock:(void (^)(NSError * _Nonnull))completionBlock
 {
-    __block NSArray<NSString *> *previousUids = nil;
-    __block NSArray<NSString *> *currentUids = nil;
+    __block NSSet<NSString *> *previousUids = nil;
+    __block NSSet<NSString *> *currentUids = nil;
     
     return [self.dataStore performBackgroundWriteTask:^(NSManagedObjectContext * _Nonnull managedObjectContext) {
         NSArray<SRGHistoryEntry *> *previousHistoryEntries = [SRGHistoryEntry objectsMatchingPredicate:nil sortedWithDescriptors:nil inManagedObjectContext:managedObjectContext];
-        previousUids = [previousHistoryEntries valueForKeyPath:[NSString stringWithFormat:@"@distinctUnionOfObjects.%@", @keypath(SRGHistoryEntry.new, uid)]];
+        NSString *keyPath = [NSString stringWithFormat:@"@distinctUnionOfObjects.%@", @keypath(SRGHistoryEntry.new, uid)];
+        previousUids = [NSSet setWithArray:[previousHistoryEntries valueForKeyPath:keyPath]];
         
         SRGHistoryEntry *historyEntry = [SRGHistoryEntry upsertWithUid:uid inManagedObjectContext:managedObjectContext];
         historyEntry.lastPlaybackTime = lastPlaybackTime;
         historyEntry.deviceUid = deviceUid;
         
-        NSMutableArray<NSString *> *uids = [previousUids mutableCopy];
+        NSMutableSet<NSString *> *uids = [previousUids mutableCopy];
         if (historyEntry.inserted) {
             [uids addObject:uid];
         }
